@model VTPL_ERP.Models.StockTransferViewModel
@{
    ViewData["Title"] = "StockTransfer";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@*<h2>StockTransfer</h2>*@
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<link rel="stylesheet" href="/resources/demos/style.css">
<style type="text/css">
    .ui-menu {
        border-radius: 0px;
        border: 1px solid #454545;
        z-index: 999999 !important;
    }
</style>
<div class="app-content content" id="mainDiv">
    <div id="focusDiv"></div>
    <div class="content-wrapper">
        <div class="content-header row">
        </div>
        <div class="content-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <h4 style="float:left" class="modal-title"><strong>Stock Transfer</strong></h4>
                    </div>
                </div>
            </div>
            <div id="productSerailModel" class="modal fade" role="dialog" tabindex='-1'>
                <div class="modal-dialog">

                    <!-- Modal content-->
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title"><i class="ft-user"></i> Stock Transfer Detail</h4>
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group col-sm-12">
                                <label for="email">Item Name:</label>
                                <span id="spnItemName"></span>
                                <input id="hdnSerialItemId" type="hidden" value="" />
                            </div>
                            <div class="form-inline">
                                <div class="col-sm-12">
                                    <div class="form-group">
                                        <div class="col-sm-6">
                                            <div class="form-group">
                                                <label for="txtItemSerialNo">Serial No: </label>
                                                <input type="text" class="form-control" id="txtItemSerialNo" style="width:65%;" maxlength="50" />
                                            </div>
                                        </div>
                                        <div class="col-sm-3" style="top:9px">
                                            <div class="form-group">
                                                <button type="button" class="btn btn-warning mr-1" data-dismiss="modal">Cancel</button><br />
                                            </div>
                                        </div>
                                        <div class="col-sm-3" style="top:9px;right:27px">
                                            <div class="form-group">
                                                <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="SaveSerialNosAndClose()">Add Qty</button><br />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">

                            </div>
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="card-content collapse show vtpl-grid-align">
                                        <div class="table-responsive" style="width:100%; overflow:auto; max-height:500px">
                                            <table class="table table-bordered table-striped" id="serialDetailsGrid">
                                                <thead>
                                                    <tr>
                                                        <th>Serial No.</th>
                                                        <th>Remove</th>
                                                    </tr>
                                                </thead>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4" id="contentInvalid" style="color:red">
                                    <i class="fa fa-exclamation-triangle" aria-hidden="true"></i>Invalid Serial No
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Revenue, Hit Rate & Deals -->

            <div class="card stock_transfer_table">
                <div class="card-body">
                    <div id="invoice-customer-details" class="row">
                        <div class="col-md-6 col-sm-12">
                            <label for="issueinput2">Stock Journal No</label>
                            @Html.TextBoxFor(x => x.StockJournalNo, new { @class = "form-control", @readonly = "readonly" })
                        </div>
                        <div class="col-md-6 col-sm-12 float-right">
                            <div class="form-group">
                                <label for="issueinput3">Date</label>
                                @Html.TextBoxFor(x => x.StockTransferDateDisplay, new { @class = "form-control" })
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">



                <div class="col-md-6">
                    <div class="card">
                        <div class="card-content collapse show">
                            <div class="card-body">
                                <form class="form">
                                    <div class="form-body">
                                        <h4 class="form-section">Source</h4>
                                        <div class="row">
                                            <div class="col-md-12">
                                                <fieldset class="form-group ">
                                                    <label for="issueinput3">Source Branch</label>
                                                    @Html.DropDownListFor(m => m.StockTransferSourceObj.BranchId, Model.SourceBranchSelectList, new { @class = "form-control" })
                                                </fieldset>
                                                <fieldset class="form-group ">
                                                    <label for="issueinput3">Stock Item</label>
                                                    <select id="SelectedStockItemId" style="width:100%;"></select>
                                                </fieldset>
                                                <div class="card-content collapse show vtpl-grid-align">
                                                    <div class="table-responsive">
                                                        <table class="table table-bordered table-striped" id="srcTransTbl">
                                                            <thead>
                                                                <tr>
                                                                    <th>Name Of Item</th>
                                                                    <th>Qty</th>
                                                                    <th>Rate</th>
                                                                    <th>Amount</th>
                                                                    <th>Delete</th>
                                                                </tr>
                                                            </thead>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                        <div class="row">
                                            <div class='col-md-6'>
                                                <div class='form-group'>
                                                    <label>Total Qty</label>
                                                    @Html.TextBoxFor(x => x.StockTransferSourceObj.TotalQty, new { @class = "form-control", @maxlength = 20 })
                                                </div>
                                            </div>
                                            <div class='col-md-6'>
                                                <div class='form-group'>
                                                    <label>Total Amount</label>
                                                    @Html.TextBoxFor(x => x.StockTransferSourceObj.TotalAmount, new { @class = "form-control", @maxlength = 20 })
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class='col-md-6'>
                                                <div class='form-group'>
                                                    <label>Narration</label>
                                                    @Html.TextAreaFor(x => x.StockTransferSourceObj.Narration, new { @class = "form-control", @maxlength = 500 })
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card">
                        <div class="card-content collapse show">
                            <div class="card-body">
                                <form class="form">
                                    <div class="form-body">
                                        <h4 class="form-section">
                                            Destination
                                        </h4>
                                        <div class="row">
                                            <div class="col-md-12">
                                                <fieldset class="form-group ">
                                                    <label for="issueinput3">Destination Branch</label>
                                                    @Html.DropDownListFor(m => m.StockTransferDestinationObj.BranchId, Model.DestinationBranchSelectList, new { @class = "form-control" })
                                                </fieldset>
                                                <div class="card-content collapse show vtpl-grid-align stock_transfer_table">
                                                    <div class="table-responsive">
                                                        <table class="table table-bordered table-striped" id="dstTransTbl">
                                                            <thead>
                                                                <tr>
                                                                    <th>Name Of Item</th>
                                                                    <th>Qty</th>
                                                                    <th>Rate</th>
                                                                    <th>Amount</th>
                                                                </tr>
                                                            </thead>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                        <div class="row">
                                            <div class='col-md-6'>
                                                <div class='form-group'>
                                                    <label>Total Qty</label>
                                                    @Html.TextBoxFor(x => x.StockTransferDestinationObj.TotalQty, new { @class = "form-control", @maxlength = 20 })
                                                </div>
                                            </div>
                                            <div class='col-md-6'>
                                                <div class='form-group'>
                                                    <label>Total Amount</label>
                                                    @Html.TextBoxFor(x => x.StockTransferDestinationObj.TotalAmount, new { @class = "form-control", @maxlength = 20 })
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class='col-md-6'>
                                                <div class='form-group'>
                                                    <label>Narration</label>
                                                    @Html.TextAreaFor(x => x.StockTransferDestinationObj.Narration, new { @class = "form-control", @maxlength = 500 })
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </form>
                            </div>
                        </div>
                    </div>
                </div>




            </div>

            <div id="invoice-footer">
                <div class="row">
                    <div class="col-md-7 col-sm-12">

                    </div>
                    <div class="col-md-5 col-sm-12 text-right">
                        <button type="button" class="btn btn-warning mr-1" onclick="@("window.location.href='" + @Url.Action("Index", "Dashboard") + "'");">Cancel</button>
                        <button id="btnSaveST" type="button" class="btn btn-primary" onclick="SaveSTWithDetials()">
                            <i class="la la-check-square-o"></i> Save
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

@section scripts{
    <script type="text/javascript">
        $(document).ready(function () {
            jQuery('#StockTransferDateDisplay').datepicker({
                format: 'dd/mm/yyyy',
                forceParse: false,
                orientation: "bottom",
            });
            $("#contentInvalid").hide();
            jQuery('#StockTransferDateDisplay').focus();
            jQuery('#StockTransferDateDisplay').focus();
            jQuery('#StockTransferSourceObj_BranchId').select2();
            $("#StockTransferSourceObj_BranchId").select2({ placeholder: 'Select Branch' });
            $("#StockTransferSourceObj_BranchId").select2("val", 0);
            jQuery('#StockTransferDestinationObj_BranchId').select2();
            $("#StockTransferDestinationObj_BranchId").select2({ placeholder: 'Select Branch' });
            $("#StockTransferDestinationObj_BranchId").select2("val", 0);
            var stockJsonData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.StockData));
            $("#SelectedStockItemId").select2({ data: stockJsonData, placeholder: 'Select Stock Item' });
            $("#SelectedStockItemId").select2("val", 0);

            $('#SelectedStockItemId').on('select2:select', function (e) {
                var data = e.params.data;
                console.log(data);
                var cnt = $("#srcTransTbl").find('.stock-row').length + 1;
                var trRow = "<tr class='stock-row' data-item-id=" + data.id + ">" +
                    "<td class='item-name'>" + data.text + "</td>" +
                    "<td class='item-qty editablecell'>1</td>" +
                    "<td class='item-rate editablecell'>" + parseFloat(data.Rate).toFixed(2) + "</td>" +
                    "<td class='item-totalamt'>0.00</td>" +
                    "<td><a href='#' class='btn btn-danger' onclick=DeleteData('" + data.id + "');><i class='ft-trash'></i></a></td>" +
                    "</tr>";
                var trDestRow = "<tr class='stockDest-row' data-item-id=" + data.id + ">" +
                    "<td class='item-destname'>" + data.text + "</td>" +
                    "<td class='item-destqty'>1</td>" +
                    "<td class='item-destrate'>" + parseFloat(data.Rate).toFixed(2) + "</td>" +
                    "<td class='item-desttotalamt'>0.00</td>" +
                    "</tr>";
                var stockTableRow = $("#srcTransTbl").find('tr.stock-row[data-item-id=' + data.id + ']');
                if (stockTableRow.length == 0) {
                    $("#srcTransTbl").append(trRow);
                    $("#dstTransTbl").append(trDestRow);
                    $("#SelectedStockItemId").select2("val", 0);
                    $('#srcTransTbl tr:last').find('.item-qty').trigger('click');
                    CalculateThisRow($('#srcTransTbl tr:last'));
                    CalculateDestThisRow($('#dstTransTbl tr:last'));
                }
                else {
                    swal("Error!", "Stock Item already added. Please select other stock item!", "error");

                }
            });
            // Tab Key Event
            $("body").on('keydown', '#mainDiv', function (e) {
                var keyCode = e.keyCode || e.which;

                if (keyCode == 9) {
                    if ($(e.target).closest('tr.stock-row').length > 0) {
                        e.preventDefault();
                        if (e.shiftKey) {
                            if ($(e.target).closest('td').prevAll('td.editablecell:eq(0)').length > 0) {
                                $(e.target).closest('td').prevAll('td.editablecell:eq(0)').trigger('click');
                            }
                            else if ($(e.target).closest('tr.stock-row').prev('tr.stock-row').length > 0) {
                                $(e.target).closest('tr.stock-row').prev('tr.stock-row').find('.item-qty').trigger('click');
                            }
                            else {
                                $("#SelectedStockItemId").select2('open');
                            }
                        }
                        else {
                            if ($(e.target).closest('td').nextAll('td.editablecell:eq(0)').length > 0) {
                                $(e.target).closest('td').nextAll('td.editablecell:eq(0)').trigger('click');
                            }
                            else if ($(e.target).closest('tr.stock-row').next('tr.stock-row').length > 0) {
                                $(e.target).closest('tr.stock-row').next('tr.stock-row').find('.item-qty').trigger('click');
                            }
                            else {
                                $("#SelectedStockItemId").select2('open');
                            }
                        }
                    }
                }
            });
            $("body").on('click', '#focusDiv', function (e) {

            });
            $("body").on('keypress', '#txtItemSerialNo', function (e) {
                if (e.keyCode == 13) {
                    var txtVal = $(this).val().trim();
                    var isDuplicate = false;
                    if ($(this).val().trim() != "") {
                        var allSerialTds = $("#serialDetailsGrid").find('tr.tr-serial td');
                        if (allSerialTds.length > 0) {
                            $.each(allSerialTds, function () {
                                if (txtVal == $(this).html()) {
                                    isDuplicate = true;
                                }
                            });
                        }
                        if (isDuplicate) {
                            swal("Error!", "This serial no is already available! Please enter different serial no", "error").then(function () {
                                $("#txtItemSerialNo").val('');
                                $("#txtItemSerialNo").focus();
                            });
                        }
                        else {
                            var sourcearray = $("#txtItemSerialNo").autocomplete("option", "source");
                            if (sourcearray.includes(txtVal) == true) {
                                $("#serialDetailsGrid").append("<tr class='tr-serial'><td>" + $(this).val() + "</td><td><a href='#' class='btn btn-danger' onclick=DeleteSerialNoData(this);><i class='ft-trash'></i></a></td></tr>");
                                $(this).val('');
                            }
                            else {
                                $("#contentInvalid").show();
                                setTimeout(function () {
                                    $("#contentInvalid").fadeOut(1000);
                                }, 2000);
                            }
                        }
                    }
                }
            });

            $(document).keyup(function (e) {
                var keyCode = e.keyCode || e.which;

                if (keyCode == 113) {
                    // f2
                    if (($("#productSerailModel").data('bs.modal') || {})._isShown) {
                        SaveSerialNosAndClose();
                    }
                }
                if (keyCode == 115) {
                    // f4
                    if (!($("#productSerailModel").data('bs.modal') || {})._isShown) {
                        $("#btnSaveST").focus();
                        SaveSTWithDetials();
                    }
                }

            });


            // QTY
            $("body").on("click", ".txt-qty", function (e) {
                //e.stopPropagation();
            });
            $("body").on("blur", ".txt-qty", function (e) {
                debugger;
                var currentQty = $(this).val();
                var currentTD_Qty = $(this).closest('.item-qty');
                $(currentTD_Qty).html(currentQty);
                CalculateThisRow($(currentTD_Qty).closest('tr.stock-row'));

                var inventoryId = $(currentTD_Qty).closest('tr.stock-row').attr('data-item-id');
                var destTableRow = $("#dstTransTbl").find('tr.stockDest-row[data-item-id=' + inventoryId + ']');
                var destStkTrans_Qty = $(destTableRow).find('.item-destqty');
                $(destStkTrans_Qty).html(currentQty);
                CalculateDestThisRow($(destStkTrans_Qty).closest('tr.stockDest-row'));
            });
            $("body").on("click", ".item-qty", function () {
                debugger;
                var oldQty = $(this).text();
                //$(this).html("<input class='txt-qty editable-txt' type='number' oninput='javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);' maxlength = '4' value=" + oldQty + " />");
                $(this).html("<label class='txt-qty editable-txt'>" + oldQty + "</label>");
                //$(this).find('.txt-qty').focus();
                //$(this).find('.txt-qty').select();
                $("#spnItemName").html($(this).closest('tr.stock-row').find('.item-name').text());
                $("#hdnSerialItemId").val($(this).closest('tr.stock-row').attr('data-item-id'));
                var sernos = $(this).closest('tr.stock-row').attr('data-serial-nos');
                if (sernos != undefined && sernos != null && sernos.trim() != "") {
                    var list = sernos.split(';');
                    for (var i = 0; i < list.length; i++) {
                        $("#serialDetailsGrid").append("<tr class='tr-serial'><td>" + list[i] + "</td><td><a href='#' class='btn btn-danger' onclick=DeleteSerialNoData(this);><i class='ft-trash'></i></a></td></tr>");
                    }
                }
                var inventoryId = $(this).closest('tr.stock-row').attr('data-item-id');//
                var branchId = $("#StockTransferSourceObj_BranchId").val();
                $.ajax({
                    url: "/api/SalesEntry/GetSerialIdsByInventoryId?inventoryId=" + inventoryId + "&&branchId=" + branchId,
                    data: {},
                    type: 'POST',
                    dataType: 'json',
                    success: function (resp) {
                        debugger;
                        $("#txtItemSerialNo").autocomplete({
                            source: resp,
                            //select: SelectData,
                            //change: ChangeData,
                        });
                        $("#productSerailModel").modal('show');
                    },
                    error: function (resp) {
                    },

                });
            });

            $("#productSerailModel").on('shown.bs.modal', function () {
                $("#txtItemSerialNo").val("");
                $("#txtItemSerialNo").focus();
            });
            $("#productSerailModel").on('hidden.bs.modal', function () {
                $("#spnItemName").html('');
                $("#hdnSerialItemId").val('');
                $(".tr-serial").remove();
                RemoveRow();
            });
            //Rate
            $("body").on("click", ".txt-rate", function (e) {
                e.stopPropagation();
            });
            $("body").on("blur", ".txt-rate", function (e) {
                var currentRate = $(this).val();
                var currentTD_Rate = $(this).closest('.item-rate');
                $(currentTD_Rate).html(currentRate);
                CalculateThisRow($(currentTD_Rate).closest('tr.stock-row'));


                var inventoryId = $(currentTD_Rate).closest('tr.stock-row').attr('data-item-id');
                var destTableRow = $("#dstTransTbl").find('tr.stockDest-row[data-item-id=' + inventoryId + ']');
                var destStkTrans_Rate = $(destTableRow).find('.item-destrate');
                $(destStkTrans_Rate).html(currentRate);
                CalculateDestThisRow($(destStkTrans_Rate).closest('tr.stockDest-row'));


                //var destStkTrans_Rate = $("#dstTransTbl").find('.item-destrate');
                //$(destStkTrans_Rate).html(currentRate);
                //CalculateThisRow($(destStkTrans_Rate).closest('tr.stockDest-row'));
                //CalculateDestThisRow($(destStkTrans_Rate).closest('tr.stockDest-row'));
            });
            $("body").on("click", ".item-rate", function () {
                var oldRate = $(this).text();
                $(this).html("<input class='txt-rate editable-txt' type='number' oninput='javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);' maxlength = '7' step='.01' value=" + oldRate + " />");
                $(this).find('.txt-rate').focus();
                $(this).find('.txt-rate').select();
            });
        });
        function CalculateThisRow(currentRow) {
            var qty = 0;
            var rate = 0;

            qty = parseFloat($(currentRow).find('.item-qty').text()).toFixed(2);
            if (isNaN(qty)) {
                qty = parseFloat($(currentRow).find('.txt-qty').val()).toFixed(2);
            }

            rate = parseFloat($(currentRow).find('.item-rate').text()).toFixed(2);
            if (isNaN(rate)) {
                rate = parseFloat($(currentRow).find('.txt-rate').val()).toFixed(2);
            }

            var totalAmt = parseFloat(qty) * parseFloat(rate);
            $(currentRow).find('.item-totalamt').html(parseFloat(totalAmt).toFixed(2));
            CalculateSourceTotal();
        }
        function CalculateDestThisRow(currentRow) {
            var qty = 0;
            var rate = 0;

            qty = parseFloat($(currentRow).find('.item-destqty').text()).toFixed(2);
            if (isNaN(qty)) {
                qty = parseFloat($(currentRow).find('.txt-destqty').val()).toFixed(2);
            }

            rate = parseFloat($(currentRow).find('.item-destrate').text()).toFixed(2);
            if (isNaN(rate)) {
                rate = parseFloat($(currentRow).find('.txt-destrate').val()).toFixed(2);
            }

            var totalAmt = parseFloat(qty) * parseFloat(rate);
            $(currentRow).find('.item-desttotalamt').html(parseFloat(totalAmt).toFixed(2));
            CalculateDestTotal();
        }
        function CalculateSourceTotal() {
            var totalqty = 0.0;
            var totalamts = 0.0;
            var $dataRows = $("#srcTransTbl").find('.stock-row');
            $dataRows.each(function (i) {
                totalqty += parseFloat($(this).find('.item-qty').html());
                totalamts += parseFloat($(this).find('.item-totalamt').html());
            });
            $("#StockTransferSourceObj_TotalQty").val(totalqty);
            $("#StockTransferSourceObj_TotalAmount").val(parseFloat(totalamts).toFixed(2));
        }
        function CalculateDestTotal() {
            var totalqty = 0.0;
            var totalamts = 0.0;
            var $dataRows = $("#dstTransTbl").find('.stockDest-row');
            $dataRows.each(function (i) {
                totalqty += parseFloat($(this).find('.item-destqty').html());
                totalamts += parseFloat($(this).find('.item-desttotalamt').html());
            });
            $("#StockTransferDestinationObj_TotalQty").val(totalqty);
            $("#StockTransferDestinationObj_TotalAmount").val(parseFloat(totalamts).toFixed(2));
        }
        function DeleteData(id) {
            swal({
                title: "Are you sure?",
                text: "Once deleted, you will not be able to recover this data!",
                icon: "warning",
                buttons: true,
                dangerMode: true,
            })
                .then((willDelete) => {
                    if (willDelete) {
                        var srcTransRow = $("#srcTransTbl").find('tr.stock-row[data-item-id=' + id + ']');
                        var dstTransRow = $("#dstTransTbl").find('tr.stockDest-row[data-item-id=' + id + ']');
                        dstTransRow.remove();
                        srcTransRow.remove();
                        CalculateSourceTotal();
                        CalculateDestTotal();
                    }
                });
        }
        function SaveSerialNosAndClose() {
            debugger;
            var allSerialTrs = $("#serialDetailsGrid").find('tr.tr-serial');
            var dataItemId = $("#hdnSerialItemId").val();
            if (allSerialTrs.length > 0) {
                var currentRow = $("#srcTransTbl").find('tr.stock-row[data-item-id=' + dataItemId + ']');
                var currentDestRow = $("#dstTransTbl").find('tr.stockDest-row[data-item-id=' + dataItemId + ']');
                var serialNos = "";
                $.each(allSerialTrs, function () {
                    if (serialNos.trim() != "") {
                        serialNos += ";";
                    }
                    serialNos += $(this).find('td').text();
                });
                $(currentRow).attr('data-serial-nos', serialNos);
                $(currentDestRow).attr('data-serial-nos', serialNos);
                $("#productSerailModel").modal('hide');
                $(currentRow).find('.item-qty').html(allSerialTrs.length);
                $(currentDestRow).find('.item-destqty').html(allSerialTrs.length);
                $(currentRow).find('.item-rate').trigger('click');
                CalculateThisRow($(currentRow));
                CalculateDestThisRow($(currentDestRow));
                $(".tr-serial").remove();
            }
            else {
            }
        }
        function DeleteSerialNoData(num) {

            $(num).closest('tr').remove();

        }
        $(document).on('focus', '.select2', function () {
            $(this).siblings('select').select2('open');
        });

        function RemoveRow() {
            var allSourceRow = $("#srcTransTbl").find('tr.stock-row');
            $.each(allSourceRow, function () {
                var srNo = $(this).attr('data-serial-nos');
                if (srNo === undefined || srNo == "") {
                    var taxId = $(this).attr('data-item-id');
                    var allDestinationRow = $("#dstTransTbl").find('tr.stockDest-row[data-item-id=' + taxId + ']');
                    allDestinationRow.remove();
                    $(this).remove();
                    CalculateSourceTotal();
                    CalculateDestTotal();
                }
            });
        }
        function SaveSTWithDetials() {
            debugger;
            try {
                if (ValidateCtrtl()) {
                    // chekc if any .txt is there or not. if there then make it focus out. ########
                    if ($('.txt-qty').length > 0 || $('.txt-rate').length > 0 || $('.txt-destqty').length > 0 || $('.txt-destrate').length > 0) {
                        $('#focusDiv').trigger("click");
                    }
                    var stModel = {};
                    stModel.StockTransferSourceObj = {},
                    stModel.StockTransferDestinationObj = {},
                    stModel.StockJournalNo = $("#StockJournalNo").val();
                    stModel.StockTransferDateString = $("#StockTransferDateDisplay").val();
                    stModel.StockTransferSourceObj.BranchId = $("#StockTransferSourceObj_BranchId").val();
                    stModel.StockTransferSourceObj.TotalQty = $("#StockTransferSourceObj_TotalQty").val();
                    stModel.StockTransferSourceObj.TotalAmount = $("#StockTransferSourceObj_TotalAmount").val();
                    stModel.StockTransferSourceObj.Narration = $("#StockTransferSourceObj_Narration").val();
                    stModel.StockTransferDestinationObj.BranchId = $("#StockTransferDestinationObj_BranchId").val();
                    stModel.StockTransferDestinationObj.TotalQty = $("#StockTransferDestinationObj_TotalQty").val();
                    stModel.StockTransferDestinationObj.TotalAmount = $("#StockTransferDestinationObj_TotalAmount").val();
                    stModel.StockTransferDestinationObj.Narration = $("#StockTransferDestinationObj_Narration").val();
                    var StockItemsSourceCollection = [];
                    var stockSourceList = $("#srcTransTbl").find('tr.stock-row');
                    $.each(stockSourceList, function () {
                        var curRow = $(this)[0];
                        var stkSrcObj = {};
                        stkSrcObj.StockTransferId = $("#StockJournalNo").val();
                        stkSrcObj.InventoryId = $(curRow).attr('data-item-id');
                        stkSrcObj.Qty = $(curRow).find('.item-qty').text();
                        stkSrcObj.Rate = $(curRow).find('.item-rate').text();
                        stkSrcObj.Amount = $(curRow).find('.item-totalamt').text();
                        stkSrcObj.SerialNos = $(curRow).attr('data-serial-nos');
                        StockItemsSourceCollection.push(stkSrcObj);
                    });
                    stModel.StockTransferSourceDetails = StockItemsSourceCollection;
                    var StockItemsDestinationCollection = [];
                    var stockDestinationList = $("#dstTransTbl").find('tr.stockDest-row');
                    $.each(stockDestinationList, function () {
                        var curRow = $(this)[0];
                        var stkDstObj = {};
                        stkDstObj.StockTransferId = $("#StockJournalNo").val();
                        stkDstObj.InventoryId = $(curRow).attr('data-item-id');
                        stkDstObj.Qty = $(curRow).find('.item-destqty').text();
                        stkDstObj.Rate = $(curRow).find('.item-destrate').text();
                        stkDstObj.Amount = $(curRow).find('.item-desttotalamt').text();
                        stkDstObj.SerialNos = $(curRow).attr('data-serial-nos');
                        StockItemsDestinationCollection.push(stkDstObj);
                    });
                    stModel.StockTransferDestinationDetails = StockItemsDestinationCollection;
                    $.ajax({
                        url: "/api/StockTransfer/SaveStockTransfer",
                        data: stModel,
                        type: 'POST',
                        dataType: 'json',
                        success: function (resp) {
                            if (resp.isError == false) {
                                swal("Success!", resp.successMessage, "success").then(function () {
                                    window.location.href = "/Dashboard/Index";
                                });
                            }
                            else {
                                swal("Error!", resp.errorMessage, "error")

                            }
                        },
                        error: function (err, er1, er2) {

                        }
                    });
                }
            } catch (err) {
                alert(err);
            }
        }
        function ValidateCtrtl() {
            var retChk = true;
            var srcbranch = $("#StockTransferSourceObj_BranchId").val();
            var dstbranch = $("#StockTransferDestinationObj_BranchId").val();
            var stDate = $("#StockTransferDateDisplay").val();
            try {
                if (stDate == null || stDate == "") {
                    swal("Error!", "Please select Date !", "error").then(function () {
                        $("#StockTransferDateDisplay").focus();
                    });
                    return false;
                }

                if (srcbranch == "0" || srcbranch == "" || srcbranch == null) {
                    swal("Error!", "Please Select Source Branch", "error").then(function () {
                        $("#StockTransferSourceObj_BranchId").focus();
                    });
                    return false;
                }
                if ($("#srcTransTbl").find('tr.stock-row').length == 0) {
                    swal("Error!", "Please add atleast one Stock Item !", "error").then(function () {
                        $("#SelectedStockItemId").focus();
                    });
                    return false;
                }
                if (dstbranch == "0" || dstbranch == "" || dstbranch == null) {
                    swal("Error!", "Please Select Destination Branch", "error").then(function () {
                        $("#StockTransferDestinationObj_BranchId").focus();
                    });
                    return false;
                }
            } catch (err) {
                alert(err);
                retChk = false;
            }
            return retChk;
        }
    </script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
}
@*< !-- ////////////////////////////////////////////////////////////////////////////-->
    < !--BEGIN VENDOR JS-- >*@
<script src="app-assets/vendors/js/vendors.min.js" type="text/javascript"></script>
<!-- BEGIN VENDOR JS-->
<!-- BEGIN PAGE VENDOR JS-->
<script src="app-assets/vendors/js/charts/chart.min.js" type="text/javascript"></script>
<script src="app-assets/vendors/js/charts/raphael-min.js" type="text/javascript"></script>
<script src="app-assets/vendors/js/charts/morris.min.js" type="text/javascript"></script>
<script src="app-assets/vendors/js/charts/jvector/jquery-jvectormap-2.0.3.min.js"
        type="text/javascript"></script>
<script src="app-assets/vendors/js/charts/jvector/jquery-jvectormap-world-mill.js"
        type="text/javascript"></script>
<script src="app-assets/data/jvector/visitor-data.js" type="text/javascript"></script>
<!-- END PAGE VENDOR JS-->
<!-- BEGIN MODERN JS-->
<script src="app-assets/js/core/app-menu.js" type="text/javascript"></script>
<script src="app-assets/js/core/app.js" type="text/javascript"></script>
<script src="app-assets/js/scripts/customizer.js" type="text/javascript"></script>
<!-- END MODERN JS-->
<!-- BEGIN PAGE LEVEL JS-->
<script src="app-assets/js/scripts/pages/dashboard-sales.js" type="text/javascript"></script>
<!-- END PAGE LEVEL JS-->
